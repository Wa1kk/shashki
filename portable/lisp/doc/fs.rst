Интерфейс управления файловой системой в OS-PI
==============================================

Файловая система -- это абстракция над способом хранения файлов на диске. Она должна включать следующие функции:

* подключение раздела диска;
* просмотр содержимого каталога;
* задание рабочего каталога;
* получение информации о файле/каталоге;
* создание/удаление файлов;
* создание/удаление каталогов;
* открытие/закрытие файлов;
* чтение/запись файлов;
* перемещение указателя чтения/записи.

Система должна сама автоматически определять тип файловой системы при подключении раздела:
::

   (load-partition disk-num part-num)
   ; Загрузить файловую систему из раздела part-num с диска disk-num
   ; Возвращает nil
   ; Возможная ошибка - неправильный номер раздела или ошибка диска

После этой команды дерево файловой системы подключено, и можно работать с файлами.

Пути к файлам в стиле UNIX: /dir/file.txt в виде строки.

Смена рабочего каталога для относительных путей:
::

   (ch-dir <путь>)
   ; Возвращает nil
   ; Возможная ошибка - неправильный путь

Просмотр содержимого каталога:
::

   (list-dir <путь>)

Результат выполнения команды содержит список строк для файлов и пару для каталогов:
::

    ("file1.txt" ; обычный файл
     "file2.txt"
     (dir."directory")) ; каталог

Если путь неправильный -- возвращается ошибка:
::

   (error "Invalid path")

Команда получения информации о файле/каталоге:
::

   (fstat "file.txt")
   ; возвращает хеш-объект
   ((name . "file1.txt")  ;имя файла/каталога              
    (size . 424242)       ;размер в байтах               
    (attrib . 32)         ;байт атрибутов
                          ; 5      4         3        2      1      0
                          ;Archive Directory VolumeID System Hidden ReadOnly
    (ctime . 1707136932)  ;время создания файла
    (cdate . 1707136932)  ;дата создания файла: число секунд с 1 января 1970 года
    (adate . 1707136932)  ;дата последнего обращения к файлу
    (wdate . 1707136932)  ;дата последней записи файла
    (wtime . 1707136932)) ;время последней записи файла
   ; Возможная ошибка - неправильный путь
    
Создание файла:
::

   (create-file <путь>) ; создает и открывает файл
                        ; возможные ошибки -- некорректный путь,
			; не хватает места, ошибка диска

Удаление файла:
::

   (remove-file <путь>) ; удаляет файл
                        ; возможные ошибки -- некорректный путь, ошибка диска

Создание каталога:
::

   (create-dir <путь>) ; создает каталог
                       ; возможные ошибки -- некорректный путь,
		       ; не хватает места, ошибка диска

Удаление каталога:
::

   (remove-dir <путь>) ; удаляет каталог
                       ; возможные ошибки -- некорректный путь, ошибка диска
		       
Открытие файла:
::

   (fopen "file.txt") ; возвращает объект-файл для дальнейшей работы
                      ; позиция указателя -- в начале файла
		      ; если файла нет -- ошибка пути или ошибка диска

Закрытие файла:
::

   (fclose <file-object>) ; возвращает nil или ошибку, если некорректный объект

Чтение файла:
::

   (fread file size)  ; Чтение из файла file количество байт size
   ; возвращает массив прочитанных байт
   ; возможная ошибки - ошибка диска, неправильный объект, неправильные параметры

Запись в файл:
::

   (fwrite file buf) ; Записать в файл file массив байт buf
   ; возвращает число записанных байт
   ; возможная ошибки - ошибка диска, неправильный объект, неправильные параметры

Перемещение указателя чтения/записи в файле:
::

   (fseek file offset direction)
   ; Перемещение позиции чтения/записи в файле file на offset байт
   ; возможная ошибки - ошибка диска, неправильный объект, неправильные параметры

direction принимает значения:

:begin: перемещение относительно начала файла
:end:   перемещение относительно конца файла
:cur:   перемещение относительно текущей позиции указателя

Реализация интерфейса файловой системы
--------------------------------------

Так как у большинства функций первый параметр это файловый объект, то имеет смысл сделать абстрактный класс File, у которого будут потомки для конкретной файловой системы. Тогда функции fclose, fread, fwrite, fseek будут являться методами.

Для остальных функций нужно сделать класс FileSystem, чтобы они автоматически выбирались в зависимости от загруженной файловой системы. Единственный экземпляр этого класса -- глобальный объект \*file-system\*. Тогда эти функции будут макросами:
::

   ; чтобы не было коллизии имен к имени макроса добавлять *
   (ch-dir "/") -> (ch-dir* *file-system" "/")

Тип файловой системы, а значит и класс будет определяться при загрузке раздела.

Параметры файла, которые есть у всех файловых систем:

:name:     имя
:size:     размер файла	   
:position: позиция чтения/записи
:blocks:   список номеров блоков, например (14 15 16)

Остальные параметры добавляются в классе потомке.

Метод fclose достаточно определить пустым для класса File, так как файловый объект может быть освобожден сборщиком мусора. В будущих реализациях можно сделать здесь сброс буферов.

Метод fseek можно сделать одинаковым для всех файловых систем. Он просто меняет позицию чтения/записи.

Размер блока у разных файловых систем может быть разный. Он определяется при загрузке файловой системы. При этом функции чтения и записи блоков -- одинаковые у всех файловых систем. Поэтому необходима глобальная переменная \*block-sectors\*, которая будет записываться при загрузке и использоваться функциями block-read и block-write. Удобно хранить в этой переменной число секторов по 512 байт для блока.

Сами функции block-read и block-write должны быть реализованы в отдельном модуле. В простой реализации они просто читают и пишут сектора. В более оптимальной реализации они могут использовать буферизацию.
