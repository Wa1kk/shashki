Реализация файловой системы FAT-32
==================================

Класс Fat32FileSystem наследуется от FileSystem, реализуя методы:

* init - инициализация файловой системы;
* fstat' - информация о файле;
* create-file' - создание файла;
* remove-file' - удаление файла;
* create-dir' - создание каталога;
* remove-dir' - удаление каталога;
* fopen' - создание файлового объекта;
* new-block - добавление нового блока для файла;
* load-dir - загрузка каталога по паре (<номер блока каталога>.<порядковый номер записи в каталоге>).
* new-file - создание новой записи каталога, на входе номер блока каталога, возвращает файловый-объект.

Класс Fat32File наследуется от File, реализуя методы:

* fread;
* fwrite.

Устройство системы FAT32
------------------------
Структура FAT32:
::

   сектор - значение
   0 - Bios Parameter Block (BPB)
   1 - FSInfo
   2 - Резерв
   ...
   7 - Копия BPB
   ...
   xx - FAT1   адрес - BPB->ReservSecCount
               длина - BPB->FATSize32
   xx - FAT2 (копия)
   xx - Данные
   xx - Корневой каталог
        маркер 0xF8FFFF0F.FFFFFFFF
   Данные

Только область данных делится на блоки (кластеры).

Таблица размещения файлов FAT
-----------------------------

Каждый элемент(кластер) хранит значения:

:0x000 0000: кластер свободен
:0xfff fff7: кластер поврежден, не должен использоваться
:0xfff fff8: последний кластер в цепочке файла или каталога

Первые два кластера зарезервированы.

Заполнение таблицы идет последовательно от начала к концу. При создании нового файла или увеличении существующего ищется первый свободный кластер.

Всего записей столько, сколько кластеров на диске. Вторая копия полностью дублирует первую (изменения в первой, отражаются во второй).

Записи каталогов
----------------

Базовая запись 32 байта:

:1:  Первый символ имени файла ASCII, если 0xe5 - то файл удален, 0 - конец каталога, свободная запись
:10: Следующие 10 символов 7 + 3 (расширение) ASCII
:1:  Атрибуты
     5       4         3        2      1      0
     Archive Directory VolumeID System Hidden ReadOnly
:1:  Резерв
:1:  Десятые доли секунды времени создания
:2:  Часы/минуты/секунды времени создания
:2:  Дата создания
:2:  Дата последнего обращения
:2:  Старшие 2 байта ссылки на первый кластер
:2:  Часы, минуты, секунды времени модификации
:2:  Дата модификации
:2:  Младшие 2 байта ссылки на первый кластер
:4:  Размер файла

Запись с длинным именем предшествует базовой, отличается по смещению 11 - байт 0xf:

:1:  Порядковый номер или 0xe5 если файл удален
:10: Первые 5 символов имени файла в Unicode
:1:  0xf
:1:  Резерв
:1:  Контрольная сумма
:12: Следующие 6 символов имени файла
:2:  Резерв
:4:  Следующие 2 символа имени файла

 Неиспользуемые символы в имени файла хранят пробелы (не включая расширение - 3 символа).

Инициализация FAT32
-------------------
При инициализации загружается BPB, загружается корневой каталог. Таблица FAT - пустой хеш-объект.

Таблицу FAT удобно хранить как хеш-объект с ключом - номер первого кластера в цепочке и значением -- список кластеров:
::

   ((2.(3 4))
    (5.(6 7))
    (8. ()))

Обновляется при необходимости. Ссылки на списки кластеров передаются в файловый объект.

Вспомогательные функции
-----------------------

Чтение кластера по номеру: (block-read 10), запись кластера - block-write.

Загрузка каталога
-----------------
Загружает каталог, используя структуру записи.

Получение информации о файле или каталоге
-----------------------------------------

Используя функцию load-path получаем пару (или ошибка). Загружаем файловый объект с помощью функции load-file, на входе пара.


Создание файла - new-file
-------------------------

Записать новую запись в каталоге по номеру блока.
Необходимо найти первый свободный элемент FAT и создать новую цепочку из одного элемента. Для обновления обеих копий FAT нужна функция с параметром - список кластеров.

Удаление файла
--------------

Необходимо обновить первый байт в записи каталога на 0xe5. Запись FAT обновляется, в номер первого кластера ставится 0.
